# PLAN91-011 - Create Routine Aggregate with Streak Tracking

**Epic**: 01-Domain-Model
**Priority**: Critical
**Estimated Effort**: Large (5-6h)
**Dependencies**: PLAN91-008 (Value Objects), PLAN91-009 (HabitPractitioner), PLAN91-010 (Habit)
**Status**: ðŸ”„ In Progress

## Context

Create the Routine aggregate root representing a 91-day commitment to a habit. This is the core of Plan 91's tracking system, implementing:
- 91-day cycle tracking
- Streak calculation
- One-strike rule enforcement
- Recurrence patterns (when the habit is expected)
- Status management

Routine is separate from Habit:
- **Habit** = Definition ("Swimming", "Read 10 pages")
- **Routine** = YOUR 91-day commitment to that habit

Design decision (from DOMAIN-SCHEMA.md v1.1):
- Only ONE active routine per habit per practitioner at a time
- Database constraint: UNIQUE(Routine.habitId + practitionerId) where status = ACTIVE

## Acceptance Criteria

- [ ] DayOfWeek enum created
- [ ] RecurrenceType enum created
- [ ] RoutineStatus enum created
- [ ] HabitStreak value object created
- [ ] RecurrenceRule value object created
- [ ] Routine aggregate created with all properties
- [ ] 91-day cycle logic implemented
- [ ] Streak calculation implemented
- [ ] One-strike rule implemented
- [ ] RoutineRepository interface created
- [ ] Comprehensive main() tests for all components
- [ ] All tests pass
- [ ] Code compiles
- [ ] No framework dependencies

## Technical Requirements

### DayOfWeek Enum

**Package**: `com.ctoblue.plan91.domain.routine`

```java
public enum DayOfWeek {
    MONDAY, TUESDAY, WEDNESDAY, THURSDAY, FRIDAY, SATURDAY, SUNDAY
}
```

### RecurrenceType Enum

**Package**: `com.ctoblue.plan91.domain.routine`

```java
public enum RecurrenceType {
    DAILY,              // Every day
    WEEKDAYS,           // Mon-Fri
    WEEKENDS,           // Sat-Sun
    SPECIFIC_DAYS,      // Selected days (e.g., Mon, Wed, Fri)
    NTH_DAY_OF_MONTH    // Nth weekday of month (e.g., first Monday)
}
```

### RoutineStatus Enum

**Package**: `com.ctoblue.plan91.domain.routine`

```java
public enum RoutineStatus {
    ACTIVE,      // Currently tracking
    PAUSED,      // Temporarily paused
    COMPLETED,   // Finished 91 days
    ABANDONED    // Gave up / streak broken
}
```

### HabitStreak Value Object

**Package**: `com.ctoblue.plan91.domain.routine`

Encapsulates streak tracking with immutable updates.

```java
public record HabitStreak(
    int currentStreak,
    int longestStreak,
    int totalCompletions,
    boolean hasUsedStrike,
    LocalDate strikeDate,
    LocalDate lastCompletionDate
) {
    public HabitStreak {
        if (currentStreak < 0) throw new IllegalArgumentException("Current streak cannot be negative");
        if (longestStreak < 0) throw new IllegalArgumentException("Longest streak cannot be negative");
        if (totalCompletions < 0) throw new IllegalArgumentException("Total completions cannot be negative");
        if (currentStreak > longestStreak) throw new IllegalArgumentException("Current cannot exceed longest");
    }

    public static HabitStreak initial() {
        return new HabitStreak(0, 0, 0, false, null, null);
    }

    public HabitStreak incrementStreak(LocalDate completionDate) {
        int newCurrent = currentStreak + 1;
        int newLongest = Math.max(longestStreak, newCurrent);
        return new HabitStreak(
            newCurrent,
            newLongest,
            totalCompletions + 1,
            hasUsedStrike,
            strikeDate,
            completionDate
        );
    }

    public HabitStreak useStrike(LocalDate date) {
        if (hasUsedStrike) {
            throw new IllegalStateException("Strike already used");
        }
        return new HabitStreak(
            currentStreak,  // Preserve streak
            longestStreak,
            totalCompletions,
            true,
            date,
            lastCompletionDate
        );
    }

    public HabitStreak resetStreak() {
        return new HabitStreak(
            0,
            longestStreak,
            totalCompletions,
            hasUsedStrike,
            strikeDate,
            lastCompletionDate
        );
    }
}
```

### RecurrenceRule Value Object

**Package**: `com.ctoblue.plan91.domain.routine`

Defines when the habit is expected.

```java
public record RecurrenceRule(
    RecurrenceType type,
    Set<DayOfWeek> specificDays,  // For SPECIFIC_DAYS
    DayOfWeek nthDay,              // For NTH_DAY_OF_MONTH
    Integer nthWeek                // For NTH_DAY_OF_MONTH (1-4)
) {
    public RecurrenceRule {
        Objects.requireNonNull(type, "RecurrenceType cannot be null");

        if (type == RecurrenceType.SPECIFIC_DAYS) {
            if (specificDays == null || specificDays.isEmpty()) {
                throw new IllegalArgumentException("SPECIFIC_DAYS requires at least one day");
            }
        }

        if (type == RecurrenceType.NTH_DAY_OF_MONTH) {
            Objects.requireNonNull(nthDay, "NTH_DAY_OF_MONTH requires nthDay");
            Objects.requireNonNull(nthWeek, "NTH_DAY_OF_MONTH requires nthWeek");
            if (nthWeek < 1 || nthWeek > 4) {
                throw new IllegalArgumentException("nthWeek must be 1-4");
            }
        }

        // Make defensive copy
        if (specificDays != null) {
            specificDays = Set.copyOf(specificDays);
        }
    }

    public static RecurrenceRule daily() {
        return new RecurrenceRule(RecurrenceType.DAILY, null, null, null);
    }

    public static RecurrenceRule weekdays() {
        return new RecurrenceRule(RecurrenceType.WEEKDAYS, null, null, null);
    }

    public static RecurrenceRule weekends() {
        return new RecurrenceRule(RecurrenceType.WEEKENDS, null, null, null);
    }

    public static RecurrenceRule specificDays(Set<DayOfWeek> days) {
        return new RecurrenceRule(RecurrenceType.SPECIFIC_DAYS, days, null, null);
    }

    public static RecurrenceRule nthDayOfMonth(DayOfWeek day, int week) {
        return new RecurrenceRule(RecurrenceType.NTH_DAY_OF_MONTH, null, day, week);
    }

    public boolean isExpectedOn(LocalDate date) {
        return switch (type) {
            case DAILY -> true;
            case WEEKDAYS -> {
                java.time.DayOfWeek javaDay = date.getDayOfWeek();
                yield javaDay != java.time.DayOfWeek.SATURDAY &&
                      javaDay != java.time.DayOfWeek.SUNDAY;
            }
            case WEEKENDS -> {
                java.time.DayOfWeek javaDay = date.getDayOfWeek();
                yield javaDay == java.time.DayOfWeek.SATURDAY ||
                      javaDay == java.time.DayOfWeek.SUNDAY;
            }
            case SPECIFIC_DAYS -> {
                DayOfWeek ourDay = convertFromJavaDay(date.getDayOfWeek());
                yield specificDays.contains(ourDay);
            }
            case NTH_DAY_OF_MONTH -> {
                // Check if this is the Nth occurrence of the specified day in the month
                DayOfWeek ourDay = convertFromJavaDay(date.getDayOfWeek());
                if (!ourDay.equals(nthDay)) yield false;

                int weekOfMonth = (date.getDayOfMonth() - 1) / 7 + 1;
                yield weekOfMonth == nthWeek;
            }
        };
    }

    private DayOfWeek convertFromJavaDay(java.time.DayOfWeek javaDay) {
        return DayOfWeek.valueOf(javaDay.name());
    }
}
```

### Routine Aggregate

**Package**: `com.ctoblue.plan91.domain.routine`

**Properties**:
```java
// Identity
private final RoutineId id;

// Links
private final HabitId habitId;
private final HabitPractitionerId practitionerId;

// Recurrence (when is it expected?)
private final RecurrenceRule recurrenceRule;

// The 91-day cycle
private final LocalDate startDate;        // Immutable
private final LocalDate expectedEndDate;  // startDate + 91 days
private LocalDate completedAt;            // When reached 91 days

// Streak tracking
private HabitStreak streak;

// Status
private RoutineStatus status;

// Timestamps
private final Instant createdAt;
private Instant updatedAt;
```

**Factory Method**:
```java
public static Routine start(
    HabitId habitId,
    HabitPractitionerId practitionerId,
    RecurrenceRule recurrenceRule,
    LocalDate startDate
) {
    return new Routine(
        RoutineId.generate(),
        habitId,
        practitionerId,
        recurrenceRule,
        startDate,
        startDate.plusDays(91),
        null,
        HabitStreak.initial(),
        RoutineStatus.ACTIVE,
        Instant.now()
    );
}
```

**Behavior Methods**:
```java
public void recordCompletion(LocalDate date) {
    // Validate can complete
    if (status != RoutineStatus.ACTIVE) {
        throw new IllegalStateException("Can only complete ACTIVE routines");
    }
    if (date.isBefore(startDate)) {
        throw new IllegalArgumentException("Cannot complete before start date");
    }
    if (date.equals(streak.lastCompletionDate())) {
        throw new IllegalArgumentException("Already completed on " + date);
    }

    // Check if expected day
    if (!recurrenceRule.isExpectedOn(date)) {
        throw new IllegalArgumentException("Not an expected day: " + date);
    }

    // Update streak
    streak = streak.incrementStreak(date);
    updatedAt = Instant.now();

    // Check if completed 91 days
    if (date.isAfter(expectedEndDate) || date.isEqual(expectedEndDate)) {
        status = RoutineStatus.COMPLETED;
        completedAt = date;
    }
}

public void recordMiss(LocalDate date) {
    if (!recurrenceRule.isExpectedOn(date)) {
        return; // Not an expected day, no penalty
    }

    if (!streak.hasUsedStrike()) {
        // First miss: use strike
        streak = streak.useStrike(date);
    } else {
        // Second miss: abandon routine
        streak = streak.resetStreak();
        status = RoutineStatus.ABANDONED;
    }
    updatedAt = Instant.now();
}

public int getDaysRemaining() {
    return (int) ChronoUnit.DAYS.between(LocalDate.now(), expectedEndDate);
}

public boolean isActive() {
    return status == RoutineStatus.ACTIVE;
}

public boolean isCompleted() {
    return status == RoutineStatus.COMPLETED;
}
```

## Implementation Strategy

### Step 1: Create Enums
- DayOfWeek
- RecurrenceType
- RoutineStatus

### Step 2: Create Value Objects
- HabitStreak with main() tests
- RecurrenceRule with main() tests

### Step 3: Create Routine Aggregate
- Constructor + factory method
- Behavior methods
- Validation
- main() tests

### Step 4: Create RoutineRepository Interface

### Step 5: Test Everything
```bash
mvn clean compile
java -ea -cp target/classes com.ctoblue.plan91.domain.routine.HabitStreak
java -ea -cp target/classes com.ctoblue.plan91.domain.routine.RecurrenceRule
java -ea -cp target/classes com.ctoblue.plan91.domain.routine.Routine
```

## Definition of Done

- [ ] All enums created
- [ ] HabitStreak value object with tests
- [ ] RecurrenceRule value object with tests
- [ ] Routine aggregate with all behavior
- [ ] RoutineRepository interface
- [ ] 40+ test cases across all components
- [ ] All tests pass
- [ ] Code compiles
- [ ] No framework dependencies

## Key Business Rules

1. **91-day cycle**: startDate + 91 = expectedEndDate
2. **One-strike rule**: First miss uses strike, second miss abandons
3. **Expected days only**: Can only complete/miss on expected days per recurrence
4. **One completion per day**: Cannot complete same day twice
5. **Active only**: Can only complete ACTIVE routines
6. **One active per habit**: Only one ACTIVE routine per habit+practitioner (enforced in repository)

## References

- docs/DOMAIN-SCHEMA.md (v1.1)
- ADR-004: Domain Model Testing with main() Methods
- Design Decision: One active routine per habit (Option B)

---

**Created**: 2026-01-30
**Last Updated**: 2026-01-31

---

## Completion Notes

**Status**: âœ… **COMPLETED** - 2026-01-31

### Implementation Summary

All components successfully implemented and tested:

**Enums Created**:
- `DayOfWeek.java` - Domain days of week enum
- `RecurrenceType.java` - 5 recurrence patterns (DAILY, WEEKDAYS, WEEKENDS, SPECIFIC_DAYS, NTH_DAY_OF_MONTH)
- `RoutineStatus.java` - 4 statuses (ACTIVE, PAUSED, COMPLETED, ABANDONED)

**Value Objects Created**:
- `HabitStreak.java` - Immutable streak tracking with one-strike rule support
  - 15 test cases covering: initial state, incrementing, strike usage, resetting, validation, immutability
  - All tests passed âœ…
- `RecurrenceRule.java` - Defines when habits are expected
  - 15 test cases covering: all recurrence types, isExpectedOn() logic, validation, immutability
  - All tests passed âœ…

**Aggregate Created**:
- `Routine.java` - 91-day commitment aggregate root
  - 20 test cases covering: lifecycle, completions, misses, one-strike rule, 91-day completion, pause/resume, validation
  - All tests passed âœ…

**Repository Interface**:
- `RoutineRepository.java` - Port for persistence with 8 methods including one-active-per-habit enforcement

### Test Results

```
HabitStreak: 15/15 tests passed âœ…
RecurrenceRule: 15/15 tests passed âœ…
Routine: 20/20 tests passed âœ…
Total: 50/50 tests passed
```

### Key Features Implemented

1. **91-day Cycle**: startDate + 91 = expectedEndDate, auto-completes when reached
2. **One-Strike Rule**: First miss uses strike and preserves streak, second miss abandons routine
3. **Recurrence Enforcement**: Can only complete on expected days based on RecurrenceRule
4. **Streak Tracking**: Current streak, longest streak, total completions with immutable updates
5. **Status Management**: ACTIVE â†’ COMPLETED/ABANDONED with proper state transitions
6. **Validation**: Comprehensive validation for dates, states, and business rules

### Files Created

1. `src/main/java/com/ctoblue/plan91/domain/routine/DayOfWeek.java`
2. `src/main/java/com/ctoblue/plan91/domain/routine/RecurrenceType.java`
3. `src/main/java/com/ctoblue/plan91/domain/routine/RoutineStatus.java`
4. `src/main/java/com/ctoblue/plan91/domain/routine/HabitStreak.java`
5. `src/main/java/com/ctoblue/plan91/domain/routine/RecurrenceRule.java`
6. `src/main/java/com/ctoblue/plan91/domain/routine/Routine.java`
7. `src/main/java/com/ctoblue/plan91/domain/routine/RoutineRepository.java`

### Acceptance Criteria Status

- [x] DayOfWeek enum created
- [x] RecurrenceType enum created
- [x] RoutineStatus enum created
- [x] HabitStreak value object created
- [x] RecurrenceRule value object created
- [x] Routine aggregate created with all properties
- [x] 91-day cycle logic implemented
- [x] Streak calculation implemented
- [x] One-strike rule implemented
- [x] RoutineRepository interface created
- [x] Comprehensive main() tests for all components
- [x] All tests pass
- [x] Code compiles
- [x] No framework dependencies

**All acceptance criteria met** âœ…
