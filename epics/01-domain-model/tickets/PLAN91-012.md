# PLAN91-012 - Create HabitEntry Entity

**Epic**: 01-Domain-Model
**Priority**: Critical
**Estimated Effort**: Small (2-3h)
**Dependencies**: PLAN91-008 (Value Objects), PLAN91-011 (Routine)
**Status**: ðŸ”„ In Progress

## Context

Create the HabitEntry entity representing a single completion record for a specific date within a Routine. This is how users record their daily progress.

Key concepts:
- **HabitEntry** = One completion on a specific date
- **Routine** owns many HabitEntries
- **Boolean habits**: Entry just marks completion
- **Numeric habits**: Entry stores actual value (e.g., "ran 5 miles", "read 30 pages")

Design decision (from DOMAIN-SCHEMA.md v1.1):
- Entries can always be deleted (Option B)
- One entry per date per routine (unique constraint)

## Acceptance Criteria

- [ ] HabitEntry entity created with all properties
- [ ] Support for both boolean and numeric tracking
- [ ] Validation for numeric values
- [ ] Optional notes support
- [ ] HabitEntryRepository interface created
- [ ] Comprehensive main() tests
- [ ] All tests pass
- [ ] Code compiles
- [ ] No framework dependencies

## Technical Requirements

### HabitEntry Entity

**Package**: `com.ctoblue.plan91.domain.habitentry`

**Properties**:
```java
// Identity
private final HabitEntryId id;

// Ownership
private final RoutineId routineId;

// When
private final LocalDate date;

// What (for boolean habits, completed=true; for numeric, stores value)
private final boolean completed;
private Integer value;  // Nullable, only for numeric habits

// Optional context
private String notes;   // Optional user notes

// Timestamps
private final Instant createdAt;
private Instant updatedAt;
```

**Factory Methods**:
```java
// For boolean habits
public static HabitEntry recordBoolean(
    RoutineId routineId,
    LocalDate date,
    String notes
) {
    return new HabitEntry(
        HabitEntryId.generate(),
        routineId,
        date,
        true,  // Boolean habits are always "completed"
        null,  // No value for boolean
        notes,
        Instant.now()
    );
}

// For numeric habits
public static HabitEntry recordNumeric(
    RoutineId routineId,
    LocalDate date,
    int value,
    String notes
) {
    return new HabitEntry(
        HabitEntryId.generate(),
        routineId,
        date,
        true,  // Mark as completed (can add target logic later)
        value,
        notes,
        Instant.now()
    );
}
```

**Behavior Methods**:
```java
// Update value (numeric habits only)
public void updateValue(int newValue) {
    if (value == null) {
        throw new IllegalStateException("Cannot update value for boolean habit");
    }
    value = newValue;
    updatedAt = Instant.now();
}

// Update notes
public void updateNotes(String newNotes) {
    notes = (newNotes == null || newNotes.isBlank()) ? null : newNotes.trim();
    updatedAt = Instant.now();
}

// Query methods
public boolean isForRoutine(RoutineId routineId) {
    return this.routineId.equals(routineId);
}

public boolean isOnDate(LocalDate date) {
    return this.date.equals(date);
}

public boolean isNumeric() {
    return value != null;
}

public boolean isBoolean() {
    return value == null;
}
```

**Validation**:
```java
public HabitEntry {
    Objects.requireNonNull(id, "HabitEntryId cannot be null");
    Objects.requireNonNull(routineId, "RoutineId cannot be null");
    Objects.requireNonNull(date, "Date cannot be null");
    Objects.requireNonNull(createdAt, "CreatedAt cannot be null");

    // Trim notes
    if (notes != null && notes.isBlank()) {
        notes = null;
    } else if (notes != null) {
        notes = notes.trim();
    }
}
```

**Equality**:
```java
@Override
public boolean equals(Object o) {
    if (this == o) return true;
    if (!(o instanceof HabitEntry that)) return false;
    return id.equals(that.id);
}

@Override
public int hashCode() {
    return Objects.hash(id);
}
```

### HabitEntryRepository Interface

**Package**: `com.ctoblue.plan91.domain.habitentry`

```java
public interface HabitEntryRepository {

    HabitEntry save(HabitEntry entry);

    Optional<HabitEntry> findById(HabitEntryId id);

    List<HabitEntry> findByRoutine(RoutineId routineId);

    Optional<HabitEntry> findByRoutineAndDate(RoutineId routineId, LocalDate date);

    List<HabitEntry> findByRoutineInDateRange(
        RoutineId routineId,
        LocalDate startDate,
        LocalDate endDate
    );

    boolean existsForRoutineAndDate(RoutineId routineId, LocalDate date);

    void delete(HabitEntryId id);
}
```

## Implementation Strategy

### Step 1: Verify HabitEntryId
- HabitEntryId should already exist from PLAN91-008
- Verify it's in the right package

### Step 2: Create HabitEntry Entity
- Constructor with validation
- Factory methods for boolean and numeric
- Behavior methods
- main() tests

### Step 3: Create HabitEntryRepository Interface
- Define all query methods
- Support routine-based queries
- Support date range queries

### Step 4: Test Everything
```bash
mvn clean compile
java -ea -cp target/classes com.ctoblue.plan91.domain.habitentry.HabitEntry
```

## Test Cases

The main() method should test:

1. **Creation Tests**:
   - Create boolean entry
   - Create numeric entry
   - Verify properties set correctly

2. **Validation Tests**:
   - Null id validation
   - Null routineId validation
   - Null date validation
   - Notes trimming

3. **Behavior Tests**:
   - Update value (numeric only)
   - Cannot update value for boolean entry
   - Update notes
   - Clear notes with blank string

4. **Query Tests**:
   - isForRoutine() works
   - isOnDate() works
   - isNumeric() works
   - isBoolean() works

5. **Equality Tests**:
   - Entries with same ID are equal
   - Entries with different IDs are not equal

Expected: 15-20 test cases

## Definition of Done

- [ ] HabitEntry entity created with all properties
- [ ] Factory methods for boolean and numeric habits
- [ ] Behavior methods implemented
- [ ] HabitEntryRepository interface created
- [ ] 15-20 test cases in main() method
- [ ] All tests pass
- [ ] Code compiles
- [ ] No framework dependencies

## Key Business Rules

1. **One entry per date per routine**: Enforced at repository level
2. **Boolean vs Numeric**: Boolean entries have null value, numeric have integer value
3. **Always deletable**: Entries can be deleted (design decision Option B)
4. **Notes are optional**: Can be null or blank
5. **Immutable date and routine**: Once created, cannot change ownership or date

## References

- docs/DOMAIN-SCHEMA.md (v1.1)
- ADR-004: Domain Model Testing with main() Methods
- Design Decision: Entries always deletable (Option B)
- PLAN91-008: HabitEntryId value object

---

**Created**: 2026-01-31
**Last Updated**: 2026-01-31

---

## Completion Notes

**Status**: âœ… **COMPLETED** - 2026-01-31

### Implementation Summary

HabitEntry entity successfully implemented with full support for both boolean and numeric habit tracking.

**Components Created**:
- `HabitEntry.java` - Entity with all properties and behavior
- `HabitEntryRepository.java` - Port for persistence with 7 methods
- HabitEntryId was already created in PLAN91-008 âœ…

**Test Results**:
```
HabitEntry: 18/18 tests passed âœ…
```

### Key Features Implemented

1. **Factory Methods**: recordBoolean() and recordNumeric() for clear intent
2. **Boolean Habits**: Value is null, just marks completion
3. **Numeric Habits**: Stores actual integer value (e.g., miles run, pages read)
4. **Mutable Properties**: Notes and value (numeric only) can be updated
5. **Immutable Properties**: Date, routine, and ID cannot change after creation
6. **Validation**: Null checks, notes trimming, blank to null conversion
7. **Query Methods**: isForRoutine(), isOnDate(), isNumeric(), isBoolean()
8. **Equality**: Based on ID only

### Files Created

1. `epics/01-domain-model/tickets/PLAN91-012.md`
2. `src/main/java/com/ctoblue/plan91/domain/habitentry/HabitEntry.java`
3. `src/main/java/com/ctoblue/plan91/domain/habitentry/HabitEntryRepository.java`

### Acceptance Criteria Status

- [x] HabitEntry entity created with all properties
- [x] Support for both boolean and numeric tracking
- [x] Validation for numeric values
- [x] Optional notes support
- [x] HabitEntryRepository interface created
- [x] Comprehensive main() tests
- [x] All tests pass
- [x] Code compiles
- [x] No framework dependencies

**All acceptance criteria met** âœ…
