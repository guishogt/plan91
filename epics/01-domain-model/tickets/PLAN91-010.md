# PLAN91-010 - Create Habit Aggregate with Public/Private Logic

**Epic**: 01-Domain-Model
**Priority**: Critical
**Estimated Effort**: Medium (3-4h)
**Dependencies**: PLAN91-008 (Value Objects), PLAN91-009 (HabitPractitioner)
**Status**: ✅ Completed

## Context

Create the Habit aggregate root representing a habit definition (the "WHAT" you want to do). Habits can be public (shared with others) or private, can be boolean or numeric tracking, and can be copied from other habits.

Habit is separate from Routine:
- **Habit** = Definition/template ("Swimming", "Read 10 pages")
- **Routine** = Your 91-day commitment to that habit

This separation allows:
- Sharing habit definitions between practitioners
- Copying public habits
- Multiple routines for the same habit over time

## Acceptance Criteria

- [ ] NumericConfig value object created
- [ ] Habit class created as aggregate root
- [ ] All properties implemented with proper types
- [ ] TrackingType enum created (BOOLEAN, NUMERIC)
- [ ] Public/private logic implemented
- [ ] Copying logic implemented (sourceHabit reference)
- [ ] Business rules validated
- [ ] HabitRepository interface created
- [ ] `public static void main()` test method with comprehensive tests
- [ ] All tests pass
- [ ] Code compiles with `mvn clean compile`
- [ ] No framework dependencies

## Technical Requirements

### TrackingType Enum

**Package**: `com.ctoblue.plan91.domain.habit`

```java
public enum TrackingType {
    BOOLEAN,    // Yes/No tracking (did it or didn't)
    NUMERIC     // Numeric tracking (e.g., 1500 meters, 10 pages)
}
```

### NumericConfig Value Object

**Package**: `com.ctoblue.plan91.domain.habit`

```java
public record NumericConfig(
    String unit,          // e.g., "meters", "pages", "minutes"
    Integer min,          // Optional minimum value
    Integer max,          // Optional maximum value
    Integer target        // Optional target value
) {
    public NumericConfig {
        if (unit == null || unit.isBlank()) {
            throw new IllegalArgumentException("Unit cannot be null or blank");
        }
        unit = unit.trim();

        if (min != null && min < 0) {
            throw new IllegalArgumentException("Min cannot be negative");
        }
        if (max != null && max < 0) {
            throw new IllegalArgumentException("Max cannot be negative");
        }
        if (target != null && target < 0) {
            throw new IllegalArgumentException("Target cannot be negative");
        }
        if (min != null && max != null && min > max) {
            throw new IllegalArgumentException("Min cannot be greater than max");
        }
    }

    public boolean isValueValid(int value) {
        if (min != null && value < min) return false;
        if (max != null && value > max) return false;
        return true;
    }
}
```

### Habit Aggregate

**Package**: `com.ctoblue.plan91.domain.habit`

**Properties** (from DOMAIN-SCHEMA.md v1.1):
```java
// Identity
private final HabitId id;

// Definition
private final String name;                 // e.g., "Pray Rosary", "Swimming"
private final String description;          // Optional details

// Tracking configuration
private final TrackingType trackingType;
private final NumericConfig numericConfig; // Only if NUMERIC

// Visibility & sharing
private final boolean isPublic;            // Can others see/copy?
private final boolean isPrivate;           // Only visible to creator

// Provenance
private final HabitPractitionerId creator;
private final HabitId sourceHabit;         // If copied from another habit

// Timestamps
private final Instant createdAt;
private Instant updatedAt;
```

### Business Rules

1. **Name**: Required, 1-200 characters, non-blank
2. **Description**: Optional, max 1000 characters
3. **TrackingType**: Required
4. **NumericConfig**: Required if trackingType is NUMERIC, null if BOOLEAN
5. **Visibility**: Cannot be both public and private
6. **Creator**: Required
7. **SourceHabit**: Optional (only set if this is a copy)
8. **CreatedAt**: Required, not in future

### Constructor

```java
public Habit(
    HabitId id,
    String name,
    String description,
    TrackingType trackingType,
    NumericConfig numericConfig,
    boolean isPublic,
    boolean isPrivate,
    HabitPractitionerId creator,
    HabitId sourceHabit,
    Instant createdAt
) {
    this.id = requireNonNull(id, "ID cannot be null");
    this.name = validateName(name);
    this.description = validateDescription(description);
    this.trackingType = requireNonNull(trackingType, "TrackingType cannot be null");
    this.numericConfig = validateNumericConfig(trackingType, numericConfig);
    validateVisibility(isPublic, isPrivate);
    this.isPublic = isPublic;
    this.isPrivate = isPrivate;
    this.creator = requireNonNull(creator, "Creator cannot be null");
    this.sourceHabit = sourceHabit;
    this.createdAt = validateCreatedAt(createdAt);
    this.updatedAt = createdAt;
}
```

### Factory Methods

```java
// Create new boolean habit
public static Habit createBoolean(
    String name,
    String description,
    boolean isPublic,
    HabitPractitionerId creator
) {
    return new Habit(
        HabitId.generate(),
        name,
        description,
        TrackingType.BOOLEAN,
        null,
        isPublic,
        !isPublic,  // If public, not private; if not public, private
        creator,
        null,
        Instant.now()
    );
}

// Create new numeric habit
public static Habit createNumeric(
    String name,
    String description,
    NumericConfig numericConfig,
    boolean isPublic,
    HabitPractitionerId creator
) {
    return new Habit(
        HabitId.generate(),
        name,
        description,
        TrackingType.NUMERIC,
        numericConfig,
        isPublic,
        !isPublic,
        creator,
        null,
        Instant.now()
    );
}

// Copy an existing habit
public static Habit copyFrom(
    Habit source,
    HabitPractitionerId newCreator
) {
    return new Habit(
        HabitId.generate(),
        source.name,
        source.description,
        source.trackingType,
        source.numericConfig,
        false,      // Copies start as private
        true,
        newCreator,
        source.id,  // Reference to source
        Instant.now()
    );
}
```

### Behavior Methods

```java
public boolean isCopy() {
    return sourceHabit != null;
}

public boolean isBoolean() {
    return trackingType == TrackingType.BOOLEAN;
}

public boolean isNumeric() {
    return trackingType == TrackingType.NUMERIC;
}

public boolean canBeCopied() {
    return isPublic;
}

public boolean isOwnedBy(HabitPractitionerId practitionerId) {
    return creator.equals(practitionerId);
}
```

### Validation Helper Methods

```java
private String validateName(String name) {
    if (name == null || name.isBlank()) {
        throw new IllegalArgumentException("Name cannot be null or blank");
    }
    String trimmed = name.trim();
    if (trimmed.length() > 200) {
        throw new IllegalArgumentException("Name cannot exceed 200 characters");
    }
    return trimmed;
}

private String validateDescription(String description) {
    if (description == null || description.isBlank()) {
        return null;  // Description is optional
    }
    String trimmed = description.trim();
    if (trimmed.length() > 1000) {
        throw new IllegalArgumentException("Description cannot exceed 1000 characters");
    }
    return trimmed;
}

private NumericConfig validateNumericConfig(TrackingType type, NumericConfig config) {
    if (type == TrackingType.NUMERIC && config == null) {
        throw new IllegalArgumentException("NumericConfig required for NUMERIC tracking");
    }
    if (type == TrackingType.BOOLEAN && config != null) {
        throw new IllegalArgumentException("NumericConfig must be null for BOOLEAN tracking");
    }
    return config;
}

private void validateVisibility(boolean isPublic, boolean isPrivate) {
    if (isPublic && isPrivate) {
        throw new IllegalArgumentException("Habit cannot be both public and private");
    }
}
```

### HabitRepository Interface

**Package**: `com.ctoblue.plan91.domain.habit`

```java
public interface HabitRepository {

    Habit save(Habit habit);

    Optional<Habit> findById(HabitId id);

    List<Habit> findByCreator(HabitPractitionerId creatorId);

    List<Habit> findPublicHabits();

    List<Habit> findCopiesOf(HabitId sourceHabitId);

    boolean existsByNameAndCreator(String name, HabitPractitionerId creatorId);

    void delete(HabitId id);
}
```

## Testing Requirements (main() method)

Test coverage should include:

1. **Create boolean habit** (factory method)
2. **Create numeric habit** (factory method)
3. **Copy habit** from public source
4. **Name validation** (null, blank, too long)
5. **Description validation** (null ok, too long)
6. **TrackingType validation** (null)
7. **NumericConfig validation** (required for NUMERIC, forbidden for BOOLEAN)
8. **Visibility validation** (cannot be both public and private)
9. **Creator validation** (null)
10. **Behavior methods** (isCopy, isBoolean, isNumeric, canBeCopied, isOwnedBy)
11. **NumericConfig validation** (unit, min/max, target, isValueValid)
12. **Equality** based on ID

## Implementation Strategy

### Step 1: Create TrackingType Enum
Simple enum with BOOLEAN and NUMERIC

### Step 2: Create NumericConfig Value Object
- Record with validation
- Method to check if value is valid
- Include main() test method

### Step 3: Create Habit Aggregate
- All properties and validation
- Factory methods for create and copy
- Behavior methods
- equals/hashCode/toString

### Step 4: Create HabitRepository Interface
- Query methods for habits

### Step 5: Test Everything
```bash
mvn clean compile
java -ea -cp target/classes com.ctoblue.plan91.domain.habit.NumericConfig
java -ea -cp target/classes com.ctoblue.plan91.domain.habit.Habit
```

## Definition of Done

- [ ] TrackingType enum created
- [ ] NumericConfig value object created with validation
- [ ] NumericConfig main() tests pass
- [ ] Habit aggregate created with all properties
- [ ] All factory methods work (createBoolean, createNumeric, copyFrom)
- [ ] All validation rules implemented and tested
- [ ] All behavior methods work
- [ ] HabitRepository interface created
- [ ] Habit main() method includes 20+ test cases
- [ ] All tests pass
- [ ] Code compiles cleanly
- [ ] No Spring/JPA dependencies

## Key Principles

1. **Aggregate Root**: Habit controls all invariants
2. **Immutability**: All fields are final
3. **Factory Methods**: createBoolean(), createNumeric(), copyFrom()
4. **Fail Fast**: Validate in constructor
5. **Self-Testing**: Comprehensive main() methods (ADR-004)
6. **No Dependencies**: Pure Java
7. **Separation**: Habit (definition) vs Routine (tracking)

## References

- docs/DOMAIN-SCHEMA.md (v1.1)
- ADR-004: Domain Model Testing with main() Methods
- Design Decision: Full copy when copying habits (Option A)

## Notes for Agent

- NumericConfig is optional (only for NUMERIC habits)
- Visibility: If public, then not private; if not public, then private
- Copies start as private (even if source was public)
- sourceHabit is null for original habits, set for copies
- This establishes the pattern for trackingType + config pattern

---

## Completion Notes

**Completed**: 2026-01-30
**Agent**: Claude Sonnet 4.5

### What Was Delivered

1. **TrackingType Enum** (`domain/habit/TrackingType.java`)
   - BOOLEAN - Yes/No tracking
   - NUMERIC - Quantity tracking with units

2. **NumericConfig Value Object** (`domain/habit/NumericConfig.java`)
   - Properties: unit, min, max, target
   - Validation: non-null unit, non-negative values, min <= max
   - Behavior: isValueValid(), meetsTarget()
   - 19 comprehensive test cases in `main()` method - ✅ All passed

3. **Habit Aggregate Root** (`domain/habit/Habit.java`)
   - Identity: HabitId
   - Definition: name, description
   - Tracking: trackingType, numericConfig
   - Visibility: isPublic, isPrivate
   - Provenance: creator, sourceHabit (for copies)
   - 25 comprehensive test cases in `main()` method - ✅ All passed

4. **HabitRepository Interface** (`domain/habit/HabitRepository.java`)
   - save(), findById(), findByCreator()
   - findPublicHabits(), findCopiesOf()
   - existsByNameAndCreator(), delete()

### Features Implemented

**Factory Methods**:
- `createBoolean()` - Create yes/no habit
- `createNumeric()` - Create quantity-tracked habit with NumericConfig
- `copyFrom()` - Copy a public habit (copies start as private)

**Validation**:
- Name: 1-200 characters, non-blank, trimmed
- Description: Optional, max 1000 characters, null if blank
- TrackingType: Required (BOOLEAN or NUMERIC)
- NumericConfig: Required for NUMERIC, forbidden for BOOLEAN
- Visibility: Cannot be both public and private
- Creator: Required
- CreatedAt: Required, not in future
- Copying: Can only copy public habits

**Behavior Methods**:
- `isCopy()` - Check if habit was copied
- `isBoolean()` / `isNumeric()` - Check tracking type
- `canBeCopied()` - Check if habit is public
- `isOwnedBy()` - Check if practitioner created this

**Business Rules**:
- If public, then not private; if not public, then private
- Copies start as private even if source was public
- NumericConfig validates min/max constraints
- Habits are immutable after creation

### Test Results

```bash
$ mvn clean compile
[INFO] BUILD SUCCESS
[INFO] Compiling 30 source files

$ java -ea -cp target/classes com.ctoblue.plan91.domain.habit.NumericConfig
✅ All NumericConfig tests passed! (19 tests)

$ java -ea -cp target/classes com.ctoblue.plan91.domain.habit.Habit
✅ All Habit tests passed! (25 tests)

Total: 44 tests across 2 classes
```

### Acceptance Criteria Met

- [x] TrackingType enum created
- [x] NumericConfig value object created with validation
- [x] NumericConfig main() tests pass (19 tests)
- [x] Habit aggregate created with all properties
- [x] All factory methods work (createBoolean, createNumeric, copyFrom)
- [x] All validation rules implemented and tested
- [x] All behavior methods work
- [x] HabitRepository interface created
- [x] Habit main() method includes 25 test cases
- [x] All tests pass
- [x] Code compiles cleanly
- [x] No Spring/JPA dependencies (pure Java 21)

### Key Features

1. **Separation of Concerns**: Habit (definition) vs Routine (tracking)
2. **Public/Private Logic**: Visibility control with validation
3. **Copying Support**: Full copy with sourceHabit reference
4. **Flexible Tracking**: Boolean or numeric with configurable units/targets
5. **Immutable**: All fields final, aggregate identity based on ID
6. **Self-Validating**: Fail-fast validation in constructor
7. **Behavior-Rich**: Not anemic - includes domain logic

### Technical Highlights

1. **Factory Methods**: createBoolean(), createNumeric(), copyFrom() for clear intent
2. **Enum + Config Pattern**: TrackingType determines if NumericConfig needed
3. **Value Object Composition**: NumericConfig encapsulates numeric tracking rules
4. **Aggregate Root Pattern**: Habit controls all invariants
5. **Repository Port**: Domain interface, infrastructure adapter pattern
6. **Standalone Testing**: 44 total tests (ADR-004)

✅ All criteria satisfied. Ready for next ticket (PLAN91-011: Create Routine aggregate).

---

**Created**: 2026-01-30
**Last Updated**: 2026-01-30
