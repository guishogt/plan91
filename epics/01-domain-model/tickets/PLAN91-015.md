# PLAN91-015 - Test One-Strike Rule with main() Scenarios

**Epic**: 01-Domain-Model
**Priority**: High
**Estimated Effort**: Medium (3-4h)
**Dependencies**: PLAN91-011 (Routine), PLAN91-012 (HabitEntry), PLAN91-014 (Domain Services)
**Status**: ðŸ”„ In Progress

## Context

Create comprehensive end-to-end tests for the one-strike rule to verify the entire flow works correctly. This is a critical business rule that needs thorough testing before moving to infrastructure.

The one-strike rule:
- **First miss on an expected day**: Use strike, preserve streak
- **Second miss on an expected day**: Break streak, abandon routine
- **Non-expected days**: Misses don't count (no penalty)

## Acceptance Criteria

- [ ] OneStrikeRuleTest class created with main() method
- [ ] Test covers all one-strike rule scenarios
- [ ] Test covers edge cases (weekends, non-expected days, etc.)
- [ ] Test verifies interaction between Routine, HabitStreak, and RecurrenceRule
- [ ] Test verifies RoutineProgressService calculations
- [ ] All tests pass
- [ ] Code compiles
- [ ] No framework dependencies

## Technical Requirements

### OneStrikeRuleTest

**Package**: `com.ctoblue.plan91.domain.routine`

**Purpose**: Comprehensive end-to-end test of the one-strike rule across all components.

**Test Scenarios**:

1. **Perfect Record Scenario**
   - Complete all expected days
   - No misses
   - Streak should grow continuously
   - Should complete 91 days successfully

2. **One Miss With Strike Scenario**
   - Miss one expected day (first miss)
   - Strike should be used
   - Streak should be preserved
   - Should still be able to complete routine

3. **Two Misses - Abandonment Scenario**
   - Miss first expected day (strike used)
   - Miss second expected day (routine abandoned)
   - Streak should reset to 0
   - Status should be ABANDONED

4. **Non-Expected Day Miss Scenario**
   - WEEKDAYS routine
   - Miss on Saturday/Sunday
   - Should have NO effect (no strike, no abandonment)
   - Streak continues normally

5. **Strike Usage Then Recovery Scenario**
   - Use strike on first miss
   - Complete all remaining days
   - Should reach 91 days and complete

6. **Multiple Routines Scenario**
   - Different recurrence rules
   - Verify one-strike rule works for each independently

7. **Edge Case: Miss on Last Day**
   - Complete 90 days
   - Miss day 91 (first miss, uses strike)
   - Complete day 92 to finish

8. **Progress Tracking During Strikes**
   - Verify RoutineProgressService calculations
   - Compliance rate should reflect misses
   - isOnTrack() should work correctly with strikes

## Implementation Strategy

### Step 1: Create Test Class
- Create OneStrikeRuleTest.java in domain/routine package
- Set up main() method structure

### Step 2: Implement Test Scenarios
- Each scenario as a separate test method called from main()
- Use clear assertions and output messages
- Verify all state transitions

### Step 3: Test Integration
- Verify Routine, HabitStreak, RecurrenceRule work together
- Verify RoutineProgressService calculations are accurate

### Step 4: Run Tests
```bash
mvn clean compile
java -ea -cp target/classes com.ctoblue.plan91.domain.routine.OneStrikeRuleTest
```

## Test Cases

Minimum 8 comprehensive scenarios covering:

1. **Happy path**: Perfect completion to 91 days
2. **Single strike**: Use strike once, continue to completion
3. **Abandonment**: Use strike, then miss again = abandoned
4. **Non-expected days**: Misses on non-expected days have no effect
5. **Recovery after strike**: Use strike early, recover, complete
6. **Edge cases**: Last day miss, immediate consecutive misses
7. **Recurrence variations**: Test with DAILY, WEEKDAYS, SPECIFIC_DAYS
8. **Progress calculations**: Verify service methods during strike scenarios

## Definition of Done

- [ ] OneStrikeRuleTest class created
- [ ] 8+ comprehensive scenarios implemented
- [ ] All scenarios pass
- [ ] Clear output showing each test result
- [ ] Code compiles
- [ ] No framework dependencies
- [ ] Verifies correct interaction between all domain components

## Key Validations

Each test should verify:
1. **Streak state**: currentStreak, longestStreak, totalCompletions
2. **Strike state**: hasUsedStrike, strikeDate
3. **Routine status**: ACTIVE, COMPLETED, or ABANDONED
4. **Progress metrics**: Compliance rate, isOnTrack status
5. **Expected behavior**: Matches business rules exactly

## References

- docs/DOMAIN-SCHEMA.md (v1.1)
- ADR-004: Domain Model Testing with main() Methods
- PLAN91-011: Routine aggregate with one-strike rule
- PLAN91-014: Domain services for progress tracking

---

**Created**: 2026-01-31
**Last Updated**: 2026-01-31

---

## Completion Notes

**Status**: âœ… **COMPLETED** - 2026-01-31

### Implementation Summary

Comprehensive end-to-end tests created for the one-strike rule, verifying the entire flow works correctly across all domain components.

**Components Created**:
- `OneStrikeRuleTest.java` - Comprehensive test suite with 8 scenarios

**Test Results**:
```
All 8 scenarios passed âœ…
- Perfect Record (91 days, no misses)
- One Miss With Strike
- Two Misses - Abandonment
- Non-Expected Day Miss (No Penalty)
- Strike Usage Then Recovery
- Multiple Recurrence Patterns
- Miss On Last Day
- Progress Tracking During Strikes
```

### Bug Fixes During Testing

Found and fixed critical bug in Routine completion logic:
- **Issue**: Routine was completing based on calendar date (90 days after start) instead of completion count
- **Fix**: Changed completion check to `streak.totalCompletions() >= 91`
- **Impact**: Now correctly requires 91 completions regardless of calendar span

Also fixed off-by-one error:
- **Issue**: Expected end date was `startDate.plusDays(91)` (92 days total)
- **Fix**: Changed to `startDate.plusDays(90)` (91 days total from day 0 to day 90)

### Key Scenarios Verified

1. **Perfect Record**: Complete all 91 days without any misses â†’ COMPLETED
2. **One Miss With Strike**: First miss uses strike, preserves streak, can continue â†’ ACTIVE
3. **Two Misses**: Second miss breaks streak and abandons routine â†’ ABANDONED
4. **Non-Expected Days**: Misses on non-expected days have zero penalty â†’ No effect
5. **Strike Recovery**: Use strike early, complete all 91 days â†’ COMPLETED
6. **Multiple Patterns**: One-strike rule works for DAILY, WEEKDAYS, SPECIFIC_DAYS
7. **Last Day Miss**: Can miss on day 90, use strike, complete on day 91
8. **Progress Tracking**: Service calculations accurate during strike scenarios

### Files Created

1. `epics/01-domain-model/tickets/PLAN91-015.md`
2. `src/main/java/com/ctoblue/plan91/domain/routine/OneStrikeRuleTest.java`

### Files Modified

1. `src/main/java/com/ctoblue/plan91/domain/routine/Routine.java` - Fixed completion logic

### Acceptance Criteria Status

- [x] OneStrikeRuleTest class created with main() method
- [x] Test covers all one-strike rule scenarios
- [x] Test covers edge cases (weekends, non-expected days, etc.)
- [x] Test verifies interaction between Routine, HabitStreak, and RecurrenceRule
- [x] Test verifies RoutineProgressService calculations
- [x] All tests pass
- [x] Code compiles
- [x] No framework dependencies

**All acceptance criteria met** âœ…
