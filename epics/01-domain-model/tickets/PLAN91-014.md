
# PLAN91-014 - Create Domain Services

**Epic**: 01-Domain-Model
**Priority**: Medium
**Estimated Effort**: Large (4-5h)
**Dependencies**: PLAN91-011 (Routine), PLAN91-012 (HabitEntry)
**Status**: ðŸ”„ In Progress

## Context

Create domain services for complex business logic that doesn't naturally fit in a single aggregate. Domain services are stateless and coordinate between aggregates or perform calculations.

Key concepts:
- **Domain Services** = Stateless operations that work with domain objects
- **Not Application Services** = These are pure domain logic, no infrastructure
- **Coordinate aggregates** = Operations that span multiple entities

## Acceptance Criteria

- [ ] RoutineProgressService created
- [ ] RecurrenceCalculatorService created
- [ ] Services are stateless
- [ ] Comprehensive main() tests for each service
- [ ] All tests pass
- [ ] Code compiles
- [ ] No framework dependencies

## Technical Requirements

### RoutineProgressService

**Package**: `com.ctoblue.plan91.domain.routine.service`

**Purpose**: Calculate progress and statistics for a routine given its entries.

**Methods**:
```java
/**
 * Calculates the compliance rate for a routine up to a given date.
 *
 * @param routine the routine
 * @param entries the habit entries for this routine
 * @param upToDate calculate compliance up to this date (inclusive)
 * @return compliance rate as percentage (0-100)
 */
public double calculateComplianceRate(
    Routine routine,
    List<HabitEntry> entries,
    LocalDate upToDate
);

/**
 * Calculates how many days were expected from start to a given date.
 *
 * @param routine the routine
 * @param upToDate calculate expected days up to this date (inclusive)
 * @return number of expected days based on recurrence rule
 */
public int countExpectedDays(Routine routine, LocalDate upToDate);

/**
 * Calculates overall progress toward the 91-day goal.
 *
 * @param routine the routine
 * @param entries the habit entries
 * @return progress as percentage (0-100)
 */
public double calculateOverallProgress(Routine routine, List<HabitEntry> entries);

/**
 * Identifies missed days (expected but no entry) up to a given date.
 *
 * @param routine the routine
 * @param entries the habit entries
 * @param upToDate check for misses up to this date (inclusive)
 * @return list of dates that were expected but missed
 */
public List<LocalDate> findMissedDays(
    Routine routine,
    List<HabitEntry> entries,
    LocalDate upToDate
);

/**
 * Checks if the routine is on track (no missed days without strike).
 *
 * @param routine the routine
 * @param entries the habit entries
 * @param asOfDate check status as of this date
 * @return true if on track, false if has missed days
 */
public boolean isOnTrack(
    Routine routine,
    List<HabitEntry> entries,
    LocalDate asOfDate
);
```

**Implementation Notes**:
- Stateless service (no fields)
- All methods are public and take domain objects as parameters
- Should not modify any objects passed to it
- Pure calculations based on domain rules

### RecurrenceCalculatorService

**Package**: `com.ctoblue.plan91.domain.routine.service`

**Purpose**: Calculate expected dates and recurrence patterns.

**Methods**:
```java
/**
 * Finds all expected dates for a recurrence rule in a date range.
 *
 * @param recurrenceRule the recurrence rule
 * @param startDate the start date (inclusive)
 * @param endDate the end date (inclusive)
 * @return list of expected dates, ordered ascending
 */
public List<LocalDate> findExpectedDates(
    RecurrenceRule recurrenceRule,
    LocalDate startDate,
    LocalDate endDate
);

/**
 * Finds the next expected date after a given date.
 *
 * @param recurrenceRule the recurrence rule
 * @param afterDate find next expected date after this
 * @return the next expected date, or empty if none within reasonable range
 */
public Optional<LocalDate> findNextExpectedDate(
    RecurrenceRule recurrenceRule,
    LocalDate afterDate
);

/**
 * Finds the previous expected date before a given date.
 *
 * @param recurrenceRule the recurrence rule
 * @param beforeDate find previous expected date before this
 * @return the previous expected date, or empty if none
 */
public Optional<LocalDate> findPreviousExpectedDate(
    RecurrenceRule recurrenceRule,
    LocalDate beforeDate
);

/**
 * Counts how many expected dates fall in a range.
 *
 * @param recurrenceRule the recurrence rule
 * @param startDate the start date (inclusive)
 * @param endDate the end date (inclusive)
 * @return count of expected dates
 */
public int countExpectedDates(
    RecurrenceRule recurrenceRule,
    LocalDate startDate,
    LocalDate endDate
);
```

**Implementation Notes**:
- Stateless service (no fields)
- Leverage RecurrenceRule.isExpectedOn() for date checking
- findNextExpectedDate() should search up to 60 days ahead (reasonable limit)
- findPreviousExpectedDate() should search up to 60 days back

## Implementation Strategy

### Step 1: Create RoutineProgressService
- Implement each calculation method
- Add comprehensive main() tests
- Test edge cases (no entries, all completed, some missed)

### Step 2: Create RecurrenceCalculatorService
- Implement date finding methods
- Add comprehensive main() tests
- Test all recurrence types (DAILY, WEEKDAYS, WEEKENDS, SPECIFIC_DAYS, NTH_DAY_OF_MONTH)

### Step 3: Test Everything
```bash
mvn clean compile
java -ea -cp target/classes com.ctoblue.plan91.domain.routine.service.RoutineProgressService
java -ea -cp target/classes com.ctoblue.plan91.domain.routine.service.RecurrenceCalculatorService
```

## Test Cases

### RoutineProgressService Tests

1. **Compliance Rate**:
   - 100% compliance (all expected days completed)
   - 0% compliance (no entries)
   - Partial compliance (some completed, some missed)
   - Compliance with future date

2. **Expected Days Count**:
   - DAILY recurrence: should equal days in range
   - WEEKDAYS recurrence: should exclude weekends
   - SPECIFIC_DAYS: should count only specific days

3. **Overall Progress**:
   - New routine (0%)
   - Halfway through (50%)
   - Completed (100%)

4. **Missed Days**:
   - No misses
   - One miss
   - Multiple consecutive misses
   - Should not count future expected days as missed

5. **On Track**:
   - Perfect record: on track
   - One miss but strike used: on track
   - Missed days: not on track

Expected: 15-20 test cases

### RecurrenceCalculatorService Tests

1. **Find Expected Dates**:
   - DAILY: every day in range
   - WEEKDAYS: only Mon-Fri
   - WEEKENDS: only Sat-Sun
   - SPECIFIC_DAYS: only specified days
   - NTH_DAY_OF_MONTH: only nth occurrences

2. **Find Next Expected Date**:
   - Next day is expected
   - Skip to next expected day
   - Cross month boundary
   - No next date within range

3. **Find Previous Expected Date**:
   - Previous day was expected
   - Skip back to previous expected
   - Cross month boundary

4. **Count Expected Dates**:
   - Week of DAILY (should be 7)
   - Week of WEEKDAYS (should be 5)
   - Month of first-monday (should be 1)

Expected: 15-20 test cases

## Definition of Done

- [ ] RoutineProgressService implemented
- [ ] RecurrenceCalculatorService implemented
- [ ] Both services are stateless
- [ ] 30-40 test cases across both services
- [ ] All tests pass
- [ ] Code compiles
- [ ] No framework dependencies
- [ ] Services only depend on domain objects

## Key Design Principles

1. **Stateless**: Services have no fields, only methods
2. **Pure functions**: Don't modify input objects, return new data
3. **Domain logic only**: No infrastructure concerns (DB, HTTP, etc.)
4. **Coordinate aggregates**: Work with Routine, HabitEntry, RecurrenceRule
5. **Testable**: All logic testable via main() methods

## References

- docs/DOMAIN-SCHEMA.md (v1.1)
- ADR-004: Domain Model Testing with main() Methods
- DDD Pattern: Domain Services for cross-aggregate operations
- PLAN91-011: Routine aggregate
- PLAN91-012: HabitEntry entity

---

**Created**: 2026-01-31
**Last Updated**: 2026-01-31

---

## Completion Notes

**Status**: âœ… **COMPLETED** - 2026-01-31

### Implementation Summary

Domain services successfully implemented for complex business logic that coordinates across aggregates.

**Components Created**:
- `RecurrenceCalculatorService.java` - Calculates expected dates and recurrence patterns (18 tests)
- `RoutineProgressService.java` - Calculates routine progress and statistics (15 tests)

**Test Results**:
```
RecurrenceCalculatorService: 18/18 tests passed âœ…
RoutineProgressService: 15/15 tests passed âœ…
Total: 33/33 tests passed
```

### Key Features Implemented

**RecurrenceCalculatorService**:
1. **findExpectedDates()** - Finds all expected dates in a range for any recurrence pattern
2. **findNextExpectedDate()** - Finds next expected date (up to 60 days ahead)
3. **findPreviousExpectedDate()** - Finds previous expected date (up to 60 days back)
4. **countExpectedDates()** - Counts expected dates in a range

**RoutineProgressService**:
1. **calculateComplianceRate()** - Calculates compliance percentage (completed/expected)
2. **countExpectedDays()** - Counts how many days were expected up to a date
3. **calculateOverallProgress()** - Calculates progress toward 91-day goal
4. **findMissedDays()** - Identifies dates that were expected but missed
5. **isOnTrack()** - Checks if routine is on track (no unexcused misses)

### Design Principles Applied

1. **Stateless Services**: No fields, only methods
2. **Pure Functions**: Don't modify input objects, return new data
3. **Domain Logic Only**: No infrastructure concerns
4. **Coordinate Aggregates**: Work with Routine, HabitEntry, RecurrenceRule
5. **Testable**: All logic testable via main() methods

### Files Created

1. `epics/01-domain-model/tickets/PLAN91-014.md`
2. `src/main/java/com/ctoblue/plan91/domain/routine/service/RecurrenceCalculatorService.java`
3. `src/main/java/com/ctoblue/plan91/domain/routine/service/RoutineProgressService.java`

### Acceptance Criteria Status

- [x] RoutineProgressService created
- [x] RecurrenceCalculatorService created
- [x] Services are stateless
- [x] Comprehensive main() tests for each service
- [x] All tests pass
- [x] Code compiles
- [x] No framework dependencies

**All acceptance criteria met** âœ…
