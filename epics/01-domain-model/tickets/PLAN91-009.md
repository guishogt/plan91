# PLAN91-009 - Create HabitPractitioner Aggregate

**Epic**: 01-Domain-Model
**Priority**: Critical
**Estimated Effort**: Medium (3-4h)
**Dependencies**: PLAN91-008 (Value Objects)
**Status**: ✅ Completed

## Context

Create the HabitPractitioner aggregate root representing a person using Plan 91. This is the first aggregate in our domain model and represents the practitioner who creates habits, starts routines, and completes entries.

HabitPractitioner is an aggregate root that encapsulates:
- Personal information (name, email)
- Authentication tracking (Auth0 ID, last login)
- Timezone information for date calculations
- Audit timestamps

## Acceptance Criteria

- [ ] HabitPractitioner class created as aggregate root
- [ ] All properties implemented with proper types
- [ ] Business rules validated in constructor
- [ ] Immutable after creation (except for tracked fields like lastLogin)
- [ ] HabitPractitionerRepository interface created
- [ ] `public static void main()` test method with comprehensive tests
- [ ] All tests pass
- [ ] Code compiles with `mvn clean compile`
- [ ] No framework dependencies (pure Java)

## Technical Requirements

### HabitPractitioner Aggregate

**Package**: `com.ctoblue.plan91.domain.habitpractitioner`

**Properties** (from DOMAIN-SCHEMA.md v1.1):
```java
// Identity
private final HabitPractitionerId id;

// Personal info
private final String firstName;
private final String lastName;
private final Email email;

// Auth & tracking
private final String auth0Id;
private Instant lastLogin;           // Mutable for tracking
private String lastLoginIp;          // Mutable for tracking
private final String originalTimezone;

// Audit timestamps
private final Instant createdAt;
private Instant updatedAt;          // Mutable for updates
```

**Business Rules**:
1. firstName: Required, 1-100 characters, non-blank
2. lastName: Required, 1-100 characters, non-blank
3. email: Required, validated via Email value object
4. auth0Id: Required, non-blank
5. originalTimezone: Required, valid timezone (e.g., "America/Los_Angeles")
6. createdAt: Required, cannot be in future
7. All IDs must be valid

### Constructor

```java
public HabitPractitioner(
    HabitPractitionerId id,
    String firstName,
    String lastName,
    Email email,
    String auth0Id,
    String originalTimezone,
    Instant createdAt
) {
    // Validation
    this.id = requireNonNull(id, "ID cannot be null");
    this.firstName = validateName(firstName, "First name");
    this.lastName = validateName(lastName, "Last name");
    this.email = requireNonNull(email, "Email cannot be null");
    this.auth0Id = validateAuth0Id(auth0Id);
    this.originalTimezone = validateTimezone(originalTimezone);
    this.createdAt = validateCreatedAt(createdAt);
    this.updatedAt = createdAt;
}
```

### Factory Method

```java
public static HabitPractitioner create(
    String firstName,
    String lastName,
    Email email,
    String auth0Id,
    String originalTimezone
) {
    return new HabitPractitioner(
        HabitPractitionerId.generate(),
        firstName,
        lastName,
        email,
        auth0Id,
        originalTimezone,
        Instant.now()
    );
}
```

### Behavior Methods

```java
public void recordLogin(String ipAddress) {
    this.lastLogin = Instant.now();
    this.lastLoginIp = ipAddress;
    this.updatedAt = Instant.now();
}

public String getFullName() {
    return firstName + " " + lastName;
}

public boolean hasLoggedIn() {
    return lastLogin != null;
}
```

### HabitPractitionerRepository Interface

**Package**: `com.ctoblue.plan91.domain.habitpractitioner`

```java
public interface HabitPractitionerRepository {

    HabitPractitioner save(HabitPractitioner practitioner);

    Optional<HabitPractitioner> findById(HabitPractitionerId id);

    Optional<HabitPractitioner> findByEmail(Email email);

    Optional<HabitPractitioner> findByAuth0Id(String auth0Id);

    boolean existsByEmail(Email email);

    void delete(HabitPractitionerId id);
}
```

### Validation Helper Methods

```java
private String validateName(String name, String fieldName) {
    if (name == null || name.isBlank()) {
        throw new IllegalArgumentException(fieldName + " cannot be null or blank");
    }
    String trimmed = name.trim();
    if (trimmed.length() < 1 || trimmed.length() > 100) {
        throw new IllegalArgumentException(fieldName + " must be 1-100 characters");
    }
    return trimmed;
}

private String validateAuth0Id(String auth0Id) {
    if (auth0Id == null || auth0Id.isBlank()) {
        throw new IllegalArgumentException("Auth0 ID cannot be null or blank");
    }
    return auth0Id.trim();
}

private String validateTimezone(String timezone) {
    if (timezone == null || timezone.isBlank()) {
        throw new IllegalArgumentException("Timezone cannot be null or blank");
    }
    // Validate it's a valid timezone ID
    try {
        ZoneId.of(timezone);
    } catch (Exception e) {
        throw new IllegalArgumentException("Invalid timezone: " + timezone);
    }
    return timezone;
}

private Instant validateCreatedAt(Instant createdAt) {
    if (createdAt == null) {
        throw new IllegalArgumentException("CreatedAt cannot be null");
    }
    if (createdAt.isAfter(Instant.now())) {
        throw new IllegalArgumentException("CreatedAt cannot be in the future");
    }
    return createdAt;
}
```

## Testing Requirements (main() method)

The standalone test should verify:

1. **Create new practitioner** (factory method)
2. **Valid construction** with all fields
3. **Name validation** (null, blank, too short, too long)
4. **Email validation** (already covered by Email value object)
5. **Auth0 ID validation** (null, blank)
6. **Timezone validation** (null, blank, invalid timezone)
7. **CreatedAt validation** (null, future date)
8. **Record login** behavior
9. **Get full name** behavior
10. **Equality** based on ID

### Example Test Structure

```java
public static void main(String[] args) {
    System.out.println("Testing HabitPractitioner...\n");

    // Test 1: Create new practitioner
    HabitPractitioner practitioner = HabitPractitioner.create(
        "Luis",
        "Martinez",
        new Email("luis@example.com"),
        "auth0|123456",
        "America/Los_Angeles"
    );
    assert practitioner != null;
    assert practitioner.getFullName().equals("Luis Martinez");
    System.out.println("✓ Test 1: Create practitioner: " + practitioner.getFullName());

    // Test 2: Record login
    practitioner.recordLogin("192.168.1.1");
    assert practitioner.hasLoggedIn();
    System.out.println("✓ Test 2: Record login works");

    // ... more tests

    System.out.println("\n✅ All HabitPractitioner tests passed!");
}
```

## Implementation Strategy

### Step 1: Create HabitPractitioner.java
- Define all properties
- Implement constructor with validation
- Add factory method `create()`
- Add behavior methods (`recordLogin`, `getFullName`, etc.)
- Add validation helper methods
- Add getters (no setters except for mutable fields)
- Override `equals()`, `hashCode()`, `toString()` based on ID

### Step 2: Create HabitPractitionerRepository.java
- Define repository interface (port)
- Include all query methods needed

### Step 3: Implement main() Test Method
- Test all validation rules
- Test factory method
- Test behavior methods
- Verify business rules

### Step 4: Compile and Test
```bash
mvn clean compile
java -ea -cp target/classes com.ctoblue.plan91.domain.habitpractitioner.HabitPractitioner
```

## Definition of Done

- [ ] HabitPractitioner class created with all properties
- [ ] All validation rules implemented and tested
- [ ] Factory method `create()` works correctly
- [ ] Behavior methods (`recordLogin`, etc.) work correctly
- [ ] HabitPractitionerRepository interface created
- [ ] main() method includes 15+ test cases
- [ ] All tests pass: "✅ All HabitPractitioner tests passed!"
- [ ] Code compiles cleanly: `mvn clean compile`
- [ ] No Spring/JPA dependencies
- [ ] equals/hashCode based on ID only
- [ ] toString() returns meaningful representation

## Key Principles

1. **Aggregate Root**: HabitPractitioner controls all invariants
2. **Immutability**: Most fields are final, only login tracking is mutable
3. **Fail Fast**: Validate in constructor, throw IllegalArgumentException
4. **Self-Testing**: Comprehensive main() method (ADR-004)
5. **No Dependencies**: Pure Java, no frameworks
6. **Domain-Driven**: Focus on business logic, not persistence

## References

- docs/DOMAIN-SCHEMA.md (v1.1)
- ADR-004: Domain Model Testing with main() Methods
- DDD Aggregates: https://martinfowler.com/bliki/DDD_Aggregate.html

## Notes for Agent

- Use Java 21 features where appropriate
- Keep validation simple but robust
- Use `Objects.requireNonNull()` for null checks
- Use ZoneId.of() to validate timezone
- Immutable by default, mutable only when necessary (lastLogin, lastLoginIp, updatedAt)
- Override equals/hashCode based on ID only (aggregate root identity)
- This is the first aggregate - set the pattern for others!

---

## Completion Notes

**Completed**: 2026-01-30
**Agent**: Claude Sonnet 4.5

### What Was Delivered

1. **HabitPractitioner Aggregate** (`domain/habitpractitioner/HabitPractitioner.java`)
   - Full aggregate root implementation with all properties
   - Identity: HabitPractitionerId
   - Personal info: firstName, lastName, Email
   - Auth tracking: auth0Id, lastLogin, lastLoginIp
   - Timezone: originalTimezone with ZoneId support
   - Audit: createdAt, updatedAt
   - 24 comprehensive test cases in `main()` method - ✅ All passed

2. **HabitPractitionerRepository Interface** (`domain/habitpractitioner/HabitPractitionerRepository.java`)
   - Repository port following Hexagonal Architecture
   - Methods: save(), findById(), findByEmail(), findByAuth0Id(), existsByEmail(), delete()
   - Uses domain types (HabitPractitionerId, Email)
   - Returns Optional for query methods

### Features Implemented

**Validation**:
- First name: Required, 1-100 characters, trimmed
- Last name: Required, 1-100 characters, trimmed
- Email: Required (validated via Email value object)
- Auth0 ID: Required, non-blank, trimmed
- Timezone: Required, valid ZoneId (e.g., "America/Los_Angeles")
- CreatedAt: Required, not in future
- IP address: Required for recordLogin()

**Behavior Methods**:
- `create()` - Factory method with generated ID and current timestamp
- `recordLogin(ipAddress)` - Records login event, updates lastLogin, lastLoginIp, updatedAt
- `getFullName()` - Returns "firstName lastName"
- `hasLoggedIn()` - Checks if lastLogin is set
- `getZoneId()` - Returns ZoneId from originalTimezone string

**Aggregate Root Pattern**:
- equals/hashCode based on ID only (aggregate identity)
- toString() returns meaningful representation
- Immutable core properties (ID, names, email, auth0Id, timezone, createdAt)
- Mutable tracking properties (lastLogin, lastLoginIp, updatedAt)

### Test Results

```bash
$ mvn clean compile
[INFO] BUILD SUCCESS
[INFO] Compiling 26 source files

$ java -ea -cp target/classes com.ctoblue.plan91.domain.habitpractitioner.HabitPractitioner
✅ All HabitPractitioner tests passed!

Test Coverage:
✓ Create practitioner (factory method)
✓ Full constructor
✓ Record login
✓ Record login updates timestamp
✓ Get full name
✓ Get ZoneId
✓ Null ID validation
✓ Null/blank/too-long first name validation
✓ Null last name validation
✓ Null email validation
✓ Null/blank Auth0 ID validation
✓ Null timezone validation
✓ Invalid timezone validation
✓ Null createdAt validation
✓ Future createdAt validation
✓ Null/blank IP validation
✓ Equality based on ID
✓ HashCode based on ID
✓ toString()
✓ Whitespace trimming
```

### Acceptance Criteria Met

- [x] HabitPractitioner class created as aggregate root
- [x] All properties implemented with proper types
- [x] Business rules validated in constructor
- [x] Immutable after creation (except tracked fields)
- [x] HabitPractitionerRepository interface created
- [x] `public static void main()` test method with 24 comprehensive tests
- [x] All tests pass
- [x] Code compiles with `mvn clean compile` - SUCCESS
- [x] No framework dependencies (pure Java 21)

### Technical Highlights

1. **Aggregate Root Pattern**: First aggregate in the domain model, sets pattern for others
2. **Java 21**: Uses modern Java features (Objects.requireNonNull, ZoneId validation)
3. **Fail-Fast Validation**: All invariants validated in constructor
4. **Factory Method**: `create()` simplifies object creation with sensible defaults
5. **Behavior-Rich**: Not anemic - includes domain behavior (recordLogin, getFullName)
6. **Hexagonal Architecture**: Repository is a port (interface) in domain layer
7. **Standalone Testing**: 24 test cases covering all validation and behavior (ADR-004)
8. **Zero Dependencies**: No Spring, JPA, or frameworks - pure domain logic

✅ All criteria satisfied. Ready for next ticket (PLAN91-010: Create Habit aggregate).

---

**Created**: 2026-01-30
**Last Updated**: 2026-01-30
