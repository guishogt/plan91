<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}">
<head>
    <title>Explore Habits</title>
    <meta name="description" content="Discover and explore community habits">
</head>
<body>

<!-- Main Content -->
<div layout:fragment="content">

    <!-- Welcome Section -->
    <div class="mb-10">
        <h1 class="text-5xl font-bold text-gray-900 mb-3">Explore Habits</h1>
        <p class="text-xl text-gray-600">Discover habits shared by the community and start your 91-day journey</p>
    </div>

    <!-- Search Bar -->
    <div class="mb-8">
        <div class="relative max-w-2xl">
            <input type="text" id="searchInput"
                   class="w-full px-6 py-4 border border-gray-300 rounded-2xl focus:ring-2 focus:ring-primary-500 focus:border-transparent shadow-md text-lg"
                   placeholder="Search for habits..."
                   onkeyup="searchHabits()">
            <svg class="absolute right-6 top-5 h-6 w-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="text-center py-12">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"></div>
        <p class="text-gray-600 mt-4">Loading habits...</p>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="hidden text-center py-12">
        <svg class="mx-auto h-16 w-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <h3 class="text-xl font-medium text-gray-900 mb-2">No habits found</h3>
        <p class="text-gray-600">Try a different search or create your own habit</p>
    </div>

    <!-- Habits Grid -->
    <div id="habitsGrid" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Habits will be inserted here -->
    </div>

</div>

<!-- JavaScript -->
<th:block layout:fragment="extra-js">
    <script th:src="@{/js/auth.js}"></script>
    <script th:src="@{/js/new-routine-modal.js}"></script>
    <script>
        let practitionerId;
        let allHabits = [];

        document.addEventListener('DOMContentLoaded', () => {
            practitionerId = getCurrentPractitionerId();
            loadPublicHabits();
        });

        async function loadPublicHabits() {
            try {
                const response = await fetch('/api/habits/public');
                if (!response.ok) throw new Error('Failed to load habits');

                allHabits = await response.json();
                displayHabits(allHabits);
            } catch (error) {
                console.error('Error loading habits:', error);
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('emptyState').classList.remove('hidden');
            }
        }

        function searchHabits() {
            const query = document.getElementById('searchInput').value.toLowerCase().trim();

            if (query === '') {
                displayHabits(allHabits);
            } else {
                const filtered = allHabits.filter(habit =>
                    habit.name.toLowerCase().includes(query) ||
                    (habit.description && habit.description.toLowerCase().includes(query))
                );
                displayHabits(filtered);
            }
        }

        function displayHabits(habits) {
            const loadingState = document.getElementById('loadingState');
            const emptyState = document.getElementById('emptyState');
            const habitsGrid = document.getElementById('habitsGrid');

            loadingState.classList.add('hidden');

            if (habits.length === 0) {
                emptyState.classList.remove('hidden');
                habitsGrid.classList.add('hidden');
            } else {
                emptyState.classList.add('hidden');
                habitsGrid.classList.remove('hidden');
                habitsGrid.innerHTML = habits.map(habit => createHabitCard(habit)).join('');
            }
        }

        function createHabitCard(habit) {
            return `
                <div class="bg-white rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-300 p-6 border border-gray-100">
                    <div class="mb-4">
                        <h3 class="text-xl font-bold text-gray-900 mb-2">${habit.name}</h3>
                        <p class="text-gray-600 text-sm line-clamp-3">${habit.description || 'No description available'}</p>
                    </div>

                    <div class="flex items-center justify-between pt-4 border-t border-gray-100">
                        <span class="text-xs text-gray-500">
                            ${habit.trackingType === 'BOOLEAN' ? 'âœ“ Simple Tracking' : 'ðŸ“Š Numeric Tracking'}
                        </span>
                        <button onclick="startRoutineFromHabit('${habit.id}', '${escapeHtml(habit.name)}')"
                                class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-all text-sm font-semibold">
                            Start Routine
                        </button>
                    </div>
                </div>
            `;
        }

        function startRoutineFromHabit(habitId, habitName) {
            selectedHabitId = habitId;
            document.getElementById('selectedHabitName').textContent = habitName;

            // Create modal if needed
            if (!document.getElementById('newRoutineModal')) {
                createNewRoutineModal();
            }

            // Show step 3 (configure routine)
            showStep(3);
            document.getElementById('newRoutineModal').classList.remove('hidden');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</th:block>

</body>
</html>
